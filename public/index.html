<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1, shrink-to-fit=no, maximum-scale=1, minimum-scale=1" />
    <meta name="robots" content="nofollow, noindex, noarchive"/>
    <meta name="author" content="gmgenove"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <title>BPAOUMN 1-B Attendance Checker</title>
    <style>
        body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;padding:16px;background:#f7fafc;color:#0f172a}
        .container{max-width:900px;margin:0 auto}
        header{display:flex;align-items:center;justify-content:space-between}
        .card{background:white;border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
        input,select,button{padding:10px;border-radius:8px;border:1px solid #e2e8f0}
        button{cursor:pointer; transition: opacity 0.2s}
        button:disabled{opacity: 0.5; cursor: not-allowed}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .small{font-size:0.9rem;color:#475569}
        .muted{color:#94a3b8}
        .error-message {color: #d93025; margin-top: 10px; font-size: 0.9em;}
        .class-card {display: flex; justify-content: space-between; align-items: flex-start; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px 16px; margin-bottom: 10px;}
        .class-actions {display: flex; flex-direction: column; gap: 6px;}
        .checkin-btn {background: #10b981; color: white; border:none}
        .footer {width: 100%; margin-top: 15px; text-align: center; font-size: 13px; color: #aaa;}
        #loading-bar { height: 3px; width: 0%; background: #3b82f6; position: fixed; top: 0; left: 0; transition: width 0.3s;}
    </style>
</head>
<body>
    <div id="loading-bar"></div>
    <div class="container">
        <header>
            <h1>BPAOUMN 1-B Attendance</h1>
            <div id="hdr" class="small muted"></div>
        </header>

        <div id="auth" class="card">
            <h3 id="formTitle">Sign In</h3>
            <form id="authForm">
                <div class="grid">
                    <div>
                        <label>Student ID</label><br>
                        <input id="userId" placeholder="2025-XXXXXX-MN-X" required />
                    </div>
                    <div class="password-wrapper">
                        <input id="passwordInput" type="password" placeholder="Enter password" required>
                        <span id="togglePassword" class="fa fa-fw fa-eye field-icon" style="cursor:pointer; margin-left:-30px;"></span>
                    </div>
                </div>
                <div style="margin-top:12px">
                    <select id="roleSelect" required>
                        <option value="">Select Role</option>
                        <option value="student">Student</option>
                        <option value="officer">Officer</option>
                    </select>
                    <button type="submit" id="submitBtn">Sign In</button>
                    <p id="switchText" class="small">Don't have an account? <a href="#">Sign up</a></p>
                </div>
                <div id="errorMsg" class="error-message"></div>
            </form>
        </div>

        <div id="app" style="display:none">
            <div class="card" style="display:flex; justify-content:space-between; align-items:center">
                <div>
                    <strong id="welcome"></strong>
                    <div class="small muted" id="roleBadge"></div>
                </div>
                <button id="signoutBtn">Sign out</button>
            </div>

            <div class="card">
                <h3>Today's Schedule</h3>
                <div id="holidayNotice"></div>
                <div id="scheduleList"></div>
            </div>

            <div id="controls" class="card" style="display:none">
                <div id="officerControls" style="display:none">
                    <h3>Officer Reports</h3>
                    <select id="reportType">
                        <option value="">Select Report Type</option>
                        <option value="class">Class Report</option>
                        <option value="person">Student Report</option>
                    </select>
                    <div id="reportParams" style="margin: 10px 0"></div>
                    <button id="generateReport">Generate PDF Report</button>
                    <div id="reportOutput"></div>
                </div>

                <div id="studentControls" style="display:none">
                    <button id="viewMyAttendance">Download My Attendance PDF</button>
                    <div id="myAttendanceOutput"></div>
                </div>
            </div>
        </div>
        <div class="footer"><p>&copy; 2026 /gmgenove</p></div>
    </div>

    <script>
        const API_BASE = '/api'; // Optimized for same-domain Render hosting
        let currentUser = null;
        let isSignup = false;

        // API Helper
        async function api(action, payload = {}) {
            const bar = document.getElementById('loading-bar');
            bar.style.width = '30%';
            try {
                const res = await fetch(API_BASE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, ...payload })
                });
                bar.style.width = '100%';
                const data = await res.json();
                if (res.status === 401) signout();
                return data;
            } catch (err) {
                return { ok: false, error: err.message };
            } finally {
                setTimeout(() => bar.style.width = '0%', 500);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const form = document.getElementById("authForm");
            const idInput = document.getElementById("userId");
            const passwordInput = document.getElementById("passwordInput");
            const roleSelect = document.getElementById("roleSelect");
            const errorMsg = document.getElementById("errorMsg");
            const submitBtn = document.getElementById("submitBtn");
            const formTitle = document.getElementById("formTitle");
            const switchText = document.getElementById("switchText");
        
            // Re-added Password visibility toggle logic
            // Ensure you have <span id="togglePassword" class="fa fa-fw fa-eye field-icon"></span> in your HTML
            const togglePassword = document.getElementById("togglePassword");
            if (togglePassword) {
                togglePassword.addEventListener("click", () => {
                    const isPassword = passwordInput.type === "password";
                    passwordInput.type = isPassword ? "text" : "password";
                    togglePassword.classList.toggle("fa-eye");
                    togglePassword.classList.toggle("fa-eye-slash");
                });
            }
        
            // Toggle between Sign In / Sign Up
            switchText.addEventListener("click", (e) => {
                e.preventDefault();
                isSignup = !isSignup;
                formTitle.textContent = isSignup ? "Sign Up" : "Sign In";
                submitBtn.textContent = isSignup ? "Sign Up" : "Sign In";
                switchText.innerHTML = isSignup 
                    ? 'Already have an account? <a href="#">Sign in</a>' 
                    : 'Donâ€™t have an account? <a href="#">Sign up</a>';
                errorMsg.textContent = "";
            });
        
            // Handle form submit
            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                errorMsg.textContent = "";
                errorMsg.style.color = "red";
                submitBtn.disabled = true;
                
                if (!idInput.value.trim() || !passwordInput.value.trim() || !roleSelect.value) {
                    errorMsg.textContent = 'Please fill in all fields and select a role';
                    submitBtn.disabled = false;
                    return;
                }
        
                const authMsg = document.getElementById('authMsg');
                if (authMsg) authMsg.textContent = isSignup ? "Signing up..." : "Signing in...";
                
                try {
                    const data = await api(isSignup ? "signup" : "signin", {
                        id: idInput.value.trim(),
                        password: passwordInput.value.trim(),
                        role: roleSelect.value
                    });
        
                    if (!data.ok) {
                        errorMsg.textContent = data.error || (isSignup ? "Signup failed" : "Login failed");
                        submitBtn.disabled = false;
                        return;
                    }
        
                    if (isSignup) {
                        errorMsg.style.color = "green";
                        errorMsg.textContent = data.message || "Signup successful! Please sign in.";
                        isSignup = false;
                        formTitle.textContent = "Sign In";
                        submitBtn.textContent = "Sign In";
                        submitBtn.disabled = false;
                        passwordInput.value = "";
                    } else {
                        currentUser = data.user;
                        localStorage.setItem("currentUser", JSON.stringify(currentUser));
                        showApp();
                    }
                } catch (err) {
                    errorMsg.textContent = "Network error: " + err.message;
                    submitBtn.disabled = false;
                } finally {
                    if (authMsg) setTimeout(() => authMsg.textContent = "", 1000);
                }
            });

            // --- Initialize Today's Date Header ---
            const updateHeaderDate = () => {
                const hdr = document.getElementById("hdr");
                if (hdr) {
                    hdr.textContent = new Date().toLocaleString("en-US", { dateStyle: 'full' });
                }
            };
            
            // --- Check for Holiday (Restored Behavior) ---
            async function checkHolidayAndDisplay() {
                const el = document.getElementById('holidayNotice');
                if (!el) return;
            
                try {
                    const res = await api('check_holiday', {});
                    if (res.ok && res.isHoliday) {
                        el.innerHTML = `<div class="pill danger" style="margin-bottom:15px; display:block; text-align:center;">
                            ðŸŽ‰ ${res.holidayName}! (${res.holidayType})
                        </div>`;
                    } else {
                        el.innerHTML = '';
                    }
                } catch (err) {
                    console.error("Holiday check failed", err);
                }
            }
            
            // --- Automatic Session Restore ---
            const restoreSession = () => {
                const raw = localStorage.getItem('currentUser');
                if (raw) {
                    try {
                        currentUser = JSON.parse(raw);
                        showApp();
                    } catch (e) {
                        localStorage.removeItem('currentUser');
                        document.getElementById('auth').style.display = 'block';
                    }
                } else {
                    document.getElementById('auth').style.display = 'block';
                }
            };
            
            // Run these on load
            updateHeaderDate();
            restoreSession();
        });

        // Auth Logic
        document.getElementById('authForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            
            const payload = {
                id: document.getElementById('userId').value.trim(),
                password: document.getElementById('passwordInput').value,
                role: document.getElementById('roleSelect').value
            };

            const res = await api(isSignup ? 'signup' : 'signin', payload);
            if (res.ok) {
                if (isSignup) {
                    alert("Signup success! Please sign in.");
                    location.reload();
                } else {
                    currentUser = res.user;
                    localStorage.setItem('currentUser', JSON.stringify(res.user));
                    showApp();
                }
            } else {
                document.getElementById('errorMsg').textContent = res.error;
            }
            btn.disabled = false;
        };

        function showApp() {
            document.getElementById('auth').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('welcome').textContent = currentUser.name;
            document.getElementById('roleBadge').textContent = currentUser.role.toUpperCase();
            
            document.getElementById('controls').style.display = 'block';
            document.getElementById('officerControls').style.display = currentUser.role === 'officer' ? 'block' : 'none';
            document.getElementById('studentControls').style.display = currentUser.role === 'student' ? 'block' : 'none';
            
            loadTodaySchedule();
        }

        async function loadTodaySchedule() {
            const list = document.getElementById('scheduleList');
            list.innerHTML = '<div class="small muted">Checking for classes...</div>';
            
            const res = await api('today_schedule');
            
            if (!res.ok) {
                list.innerHTML = '<div class="error-message">Failed to load schedule.</div>';
                return;
            }
        
            // Check if the list is empty
            if (!res.schedule || res.schedule.length === 0) {
                list.innerHTML = `
                    <div class="card" style="text-align:center; padding: 40px 20px; border: 1px dashed #cbd5e1; background: #f8fafc;">
                        <i class="fa fa-calendar-o" style="font-size: 2rem; color: #94a3b8; margin-bottom: 10px;"></i>
                        <div class="small muted">There are no classes scheduled for today.</div>
                        <div class="small" style="margin-top:5px; color: #64748b;">Enjoy your break!</div>
                    </div>
                `;
                return;
            }
        
            // Otherwise, clear and loop through classes
            list.innerHTML = '';
            res.schedule.forEach(cls => {
                const card = document.createElement('div');
                card.className = 'class-card';
                card.innerHTML = `
                    <div>
                        <strong>${cls.class_name}</strong><br>
                        <span class="small muted">${cls.start_time} - ${cls.end_time} | Prof: ${cls.professor_name}</span>
                        <div id="status-${cls.class_code}" class="small" style="margin-top:5px">Checking status...</div>
                    </div>
                    <div class="class-actions">
                        <button class="checkin-btn" id="btn-${cls.class_code}" disabled>Check In</button>
                    </div>
                `;
                list.appendChild(card);
                updateCheckinUI(cls);
            });
        }

        async function updateCheckinUI(cls) {
            const btn = document.getElementById(`btn-${cls.class_code}`);
            const statusSpan = document.getElementById(`status-${cls.class_code}`);
            
            // 1. Initial status check from server
            const res = await api('get_attendance', { class_code: cls.class_code, student_id: currentUser.id });
            
            if (res.record && res.record.status !== 'not_recorded') {
                statusSpan.textContent = `Status: ${res.record.attendance_status}`;
                btn.style.display = 'none';
                return; // Stop here if already recorded
            }
        
            // 2. Countdown Logic for "Not Yet Open" classes
            const updateCountdown = () => {
                const tzNow = new Date();
                const [hh, mm] = cls.start_time.split(':');
                const start = new Date();
                start.setHours(parseInt(hh), parseInt(mm), 0, 0);
        
                // Your check-in window (matches server: 10 mins before)
                const enableFrom = new Date(start.getTime() - 10 * 60000); 
                const minsRemaining = Math.ceil((enableFrom - tzNow) / 60000);
        
                if (tzNow >= enableFrom) {
                    // Window is open!
                    btn.disabled = false;
                    statusSpan.textContent = "Check-in window is OPEN";
                    statusSpan.style.color = "#10b981";
                    clearInterval(timer); // Stop counting down once open
                } else if (minsRemaining > 0 && minsRemaining <= 10) {
                    // Approaching opening time
                    btn.disabled = true;
                    statusSpan.textContent = `Check-in opens in ${minsRemaining} min${minsRemaining > 1 ? 's' : ''}`;
                    statusSpan.style.color = "#f59e0b";
                } else {
                    // Far in the future
                    btn.disabled = true;
                    statusSpan.textContent = `Check-in opens at ${cls.start_time}`;
                }
            };
        
            // Run immediately and then every 30 seconds
            updateCountdown();
            const timer = setInterval(updateCountdown, 30000);
        
            // 3. Handle the Click
            btn.onclick = async () => {
                btn.disabled = true;
                statusSpan.textContent = 'Verifying...';
                const checkRes = await api('checkin', { class_code: cls.class_code, student_id: currentUser.id });
                
                if (checkRes.ok) {
                    statusSpan.textContent = `Status: ${checkRes.status}`;
                    statusSpan.style.color = "#10b981";
                    btn.style.display = 'none';
                    clearInterval(timer);
                } else {
                    alert(checkRes.error);
                    btn.disabled = false;
                    updateCountdown(); // Reset UI state
                }
            };
        }

        // Optimized Report Handler
        document.getElementById('reportType').onchange = async (e) => {
            const container = document.getElementById('reportParams');
            const type = e.target.value;
            if (!type) return container.innerHTML = '';
            
            container.innerHTML = 'Loading options...';
            const data = await api('get_dropdowns');
            
            if (type === 'class') {
                container.innerHTML = `<select id="paramId"><option value="">Select Class</option>${data.classes.map(c => `<option value="${c.code}">${c.name}</option>`).join('')}</select>`;
            } else {
                container.innerHTML = `<select id="paramId"><option value="">Select Student</option>${data.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select>`;
            }
        };

        document.getElementById('generateReport').onclick = async () => {
            const type = document.getElementById('reportType').value;
            const param = document.getElementById('paramId')?.value;
            if (!param) return alert("Please select a target.");

            const out = document.getElementById('reportOutput');
            out.textContent = "Generating PDF...";
            
            const res = await api('report', { type, [type === 'class' ? 'class_code' : 'student_id']: param });
            if (res.ok) {
                const link = document.createElement('a');
                link.href = `data:application/pdf;base64,${res.pdfMain}`; // You can merge here using pdf-lib if needed
                link.download = res.filename;
                link.textContent = "Download Generated Report";
                out.innerHTML = '';
                out.appendChild(link);
            } else {
                out.textContent = res.error;
            }
        };

        function signout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            
            // Reset UI
            document.getElementById('app').style.display = 'none';
            document.getElementById('auth').style.display = 'block';
            document.getElementById("authForm").reset();
            document.getElementById("errorMsg").textContent = "";
            
            // Reset to Sign-In mode
            isSignup = false;
            document.getElementById("formTitle").textContent = "Sign In";
            document.getElementById("submitBtn").textContent = "Sign In";
            document.getElementById("submitBtn").disabled = false;
            //location.reload();
        }
        document.getElementById('signoutBtn').onclick = signout;

        window.onload = () => {
            const saved = localStorage.getItem('currentUser');
            if (saved) {
                currentUser = JSON.parse(saved);
                showApp();
            }
        };
    </script>
</body>
</html>
