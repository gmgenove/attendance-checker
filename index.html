<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Checker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col items-center p-6">
  <div class="w-full max-w-4xl bg-white shadow-lg rounded-2xl p-8 mt-6">
    <h1 class="text-3xl font-bold text-center mb-6 text-blue-700">Block Section Attendance Checker</h1>

    <!-- Login Section -->
    <div id="loginSection" class="space-y-4">
      <h2 class="text-xl font-semibold">Login</h2>
      <input id="userId" type="text" placeholder="Enter Student/Professor/Officer ID" class="w-full p-2 border rounded-lg" />
      <button onclick="login()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg w-full">Login</button>
    </div>

    <!-- Schedule Section -->
    <div id="scheduleSection" class="hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 id="welcomeText" class="text-xl font-semibold"></h2>
        <button onclick="logout()" class="text-sm text-red-600 hover:underline">Logout</button>
      </div>
      <h3 class="text-lg font-semibold mb-2 text-blue-600">Today's Classes</h3>
      <div id="scheduleList" class="space-y-4"></div>
    </div>

    <!-- Reports Section (Professors & Officers) -->
    <div id="reportSection" class="hidden mt-8">
      <h3 class="text-lg font-semibold mb-2 text-green-600">Generate Attendance Reports</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="font-semibold">Filter Type:</label>
          <select id="reportType" class="w-full p-2 border rounded-lg">
            <option value="class">By Class</option>
            <option value="date">By Date</option>
            <option value="person">By Person</option>
            <option value="week">By Week</option>
            <option value="semester">Whole Semester</option>
          </select>
        </div>
        <div>
          <label class="font-semibold">Value:</label>
          <input id="reportValue" type="text" placeholder="Enter Class Name / Date / ID / etc." class="w-full p-2 border rounded-lg" />
        </div>
      </div>
      <button onclick="generateReport()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg mt-4 w-full">Generate Report</button>
      <div id="reportOutput" class="mt-4"></div>
    </div>
  </div>

  <script>
    const scriptURL = "YOUR_APPS_SCRIPT_WEB_APP_URL"; // Replace this with your deployed Google Apps Script URL
    let currentUser = null;

    async function login() {
      const userId = document.getElementById('userId').value.trim();
      if (!userId) return alert("Please enter your ID.");

      const response = await fetch(`${scriptURL}?action=login&id=${encodeURIComponent(userId)}`);
      const data = await response.json();

      if (data.success) {
        currentUser = data.user;
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('scheduleSection').classList.remove('hidden');
        document.getElementById('welcomeText').innerText = `Welcome, ${currentUser.name} (${currentUser.role})`;
        loadSchedule();
        if (['professor', 'officer'].includes(currentUser.role.toLowerCase())) {
          document.getElementById('reportSection').classList.remove('hidden');
        }
      } else {
        alert("Login failed. Please check your ID.");
      }
    }

    function logout() {
      currentUser = null;
      document.getElementById('loginSection').classList.remove('hidden');
      document.getElementById('scheduleSection').classList.add('hidden');
      document.getElementById('reportSection').classList.add('hidden');
    }

    async function loadSchedule() {
      const today = new Date().toLocaleDateString('en-PH', { weekday: 'long' });
      const response = await fetch(`${scriptURL}?action=getSchedule&day=${encodeURIComponent(today)}`);
      const data = await response.json();

      const container = document.getElementById('scheduleList');
      container.innerHTML = "";

      if (data.length === 0) {
        container.innerHTML = "<p>No classes today.</p>";
        return;
      }

      data.forEach(cls => {
        const classCard = document.createElement('div');
        classCard.className = "border p-4 rounded-lg shadow-sm";

        const now = new Date();
        const startTime = new Date();
        const [h, m] = cls.start.split(':');
        startTime.setHours(h, m, 0, 0);
        const endTime = new Date(startTime.getTime() + cls.duration * 60000);

        const checkinOpen = new Date(startTime.getTime() - 10 * 60000);
        const graceEnd = new Date(startTime.getTime() + 5 * 60000);
        const absentTime = new Date(startTime.getTime() + 10 * 60000);

        let buttonState = "";
        let buttonText = "Check In";
        let disabled = false;

        if (now < checkinOpen) {
          buttonText = "Not Yet Available";
          disabled = true;
        } else if (now > absentTime) {
          buttonText = "Absent";
          disabled = true;
        } else if (now > startTime && now <= graceEnd) {
          buttonText = "Check In (Late)";
        }

        classCard.innerHTML = `
          <h4 class="font-semibold text-lg">${cls.name}</h4>
          <p>${cls.time}</p>
          <button class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-lg ${disabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-blue-700'}"
            ${disabled ? 'disabled' : ''}
            onclick="checkIn('${cls.name}', '${cls.time}')">
            ${buttonText}
          </button>
        `;
        container.appendChild(classCard);
      });
    }

    async function checkIn(className, time) {
      if (!currentUser) return alert("You must be logged in.");

      const response = await fetch(`${scriptURL}?action=checkIn&id=${currentUser.id}&class=${encodeURIComponent(className)}&time=${encodeURIComponent(time)}`);
      const data = await response.json();
      alert(data.message);
      loadSchedule();
    }

    async function generateReport() {
      const type = document.getElementById('reportType').value;
      const value = document.getElementById('reportValue').value.trim();

      const response = await fetch(`${scriptURL}?action=generateReport&type=${type}&value=${encodeURIComponent(value)}`);
      const data = await response.json();

      const output = document.getElementById('reportOutput');
      if (data.length === 0) {
        output.innerHTML = "<p>No records found.</p>";
      } else {
        let html = `<table class="w-full border mt-2 text-sm"><tr class="bg-gray-200"><th>Student</th><th>Class</th><th>Date</th><th>Status</th></tr>`;
        data.forEach(row => {
          html += `<tr><td>${row.student}</td><td>${row.class}</td><td>${row.date}</td><td>${row.status}</td></tr>`;
        });
        html += "</table>";
        output.innerHTML = html;
      }
    }
  </script>
</body>
</html>
