<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Attendance Checker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="referrer" content="no-referrer" />
    <style>
      body { font-family: Arial; padding: 20px; max-width: 500px; margin: auto; }
      input, button { padding: 10px; margin: 5px; width: 100%; }
      table { width: 100%; border-collapse: collapse; margin-top: 10px; }
      th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
      th { background-color: #f0f0f0; }
    </style>
  </head>
  <body>
  
    <div id="login-section">
      <h2>Student Login</h2>
      <input id="student_id" placeholder="Enter your Student ID">
      <button onclick="login()">Login</button>
    </div>
  
    <div id="app" style="display:none;">
      <h3>Welcome, <span id="user-name"></span></h3>
      <button onclick="logout()">Logout</button>
      <hr>
      <h4>Todayâ€™s Schedule</h4>
      <div id="schedule"></div>
    </div>
  
    <script>
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxOUNrkFLY0oTIYtucapUS3FKNL7FB2OChPtpeZW5l7uWnD5LBNKhcFJRBGl-H8IU4W/exec"; // <-- replace this!
    
    let currentUser = localStorage.getItem("student_id") || null;
    
    if (currentUser) {
      document.getElementById("login-section").style.display = "none";
      document.getElementById("app").style.display = "block";
      document.getElementById("user-name").textContent = currentUser;
      loadTodaySchedule();
    }
    
    function login() {
      const id = document.getElementById('student_id').value.trim();
      if (!id) return alert("Enter your Student ID");
      currentUser = id;
      localStorage.setItem("student_id", id);
      document.getElementById("login-section").style.display = "none";
      document.getElementById("app").style.display = "block";
      document.getElementById("user-name").textContent = id;
      loadTodaySchedule();
    }
    
    function logout() {
      localStorage.removeItem("student_id");
      currentUser = null;
      location.reload();
    }
    
    async function apiPost(action, body) {
      const payload = Object.assign({}, { action: action }, body || {});
      const res = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
      });
      return res.json();
    }
    
    async function loadTodaySchedule() {
      const data = await apiPost('api.getSchedule');
      if (!data.ok) return alert(data.error);
    
      let html = `<table><tr><th>Class Code</th><th>Subject</th><th>Time</th><th>Action</th></tr>`;
      data.schedule.forEach(row => {
        const classCode = row[0];
        const subject = row[1];
        const time = row[3];
        html += `<tr>
          <td>${classCode}</td>
          <td>${subject}</td>
          <td>${time}</td>
          <td><button onclick="checkIn('${classCode}')">Check In</button></td>
        </tr>`;
      });
      html += `</table>`;
      document.getElementById("schedule").innerHTML = html;
    }
    
    async function checkIn(classCode) {
      const res = await apiPost('api.checkIn', { student_id: currentUser, class_code: classCode });
      if (!res.ok) return alert(res.error);
      alert(`Checked in: ${res.status} (${res.checkin_time})`);
    }
    </script>
  
  </body>
</html>
