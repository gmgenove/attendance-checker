<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>BPAOUMN 1-B Attendance Checker</title>
    <style>
      /* Minimal clean styling */
      body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;padding:16px;background:#f7fafc;color:#0f172a}
      .container{max-width:900px;margin:0 auto}
      header{display:flex;align-items:center;justify-content:space-between}
      .card{background:white;border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
      input,select,button{padding:10px;border-radius:8px;border:1px solid #e2e8f0}
      button{cursor:pointer}
      .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
      table{width:100%;border-collapse:collapse}
      th,td{padding:8px;border-bottom:1px solid #edf2f7;text-align:left}
      .small{font-size:0.9rem;color:#475569}
      .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#e6f4ea;color:#064e3b}
      .danger{background:#fff1f2;color:#7f1d1d}
      .muted{color:#94a3b8}

      .login-card {
        max-width: 300px;
        margin: 40px auto;
        padding: 20px;
        border-radius: 12px;
        background: #f9f9f9;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
      .form-group {
        margin-bottom: 15px;
      }
      .password-wrapper {
        display: flex;
        align-items: center;
      }
      .password-wrapper input {
        flex: 1;
      }
      
      .toggle-btn {
        margin-left: 6px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.1em;
      }
      .error-message {
        color: #d93025; /* Google-style red */
        margin-top: 10px;
        font-size: 0.9em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>BPAOUMN 1-B Attendance Checker</h1>
        <div id="hdr" class="small muted"></div>
      </header>

      <div class="login-card">
        <h2>Sign In</h2>
        <form id="loginForm">
          <div class="form-group">
            <label for="idInput">ID</label>
            <input type="text" id="idInuserIdput" placeholder="Enter your ID" required />
          </div>
      
          <div class="form-group">
            <label for="passwordInput">Password</label>
            <div class="password-wrapper">
              <input type="password" id="passwordInput" placeholder="Enter your password" required />
              <button type="button" id="togglePassword" class="toggle-btn">üëÅÔ∏è</button>
            </div>
          </div>
      
          <div class="form-group">
            <label for="roleSelect">Role</label>
            <select id="roleSelect" required>
              <option value="">Select Role</option>
              <option value="student">Student</option>
              <option value="officer">Officer</option>
              <option value="professor">Professor</option>
            </select>
          </div>
      
          <button type="submit" id="loginBtn">Sign In</button>
          <div id="errorMsg" class="error-message"></div>
        </form>
      </div>
      
      <div id="app" style="display:none">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <strong id="welcome"></strong>
              <div class="small muted" id="roleBadge"></div>
            </div>
            <div>
              <button id="signoutBtn">Sign out</button>
            </div>
          </div>
        </div>

        <div class="card" id="todayScheduleCard">
          <h3>Today's Schedule</h3>
          <div id="todayMsg" class="small muted">Loading schedule...</div>
          <div id="scheduleList"></div>
        </div>
  
        <div class="card" id="controls" style="display:none">
          <h3>Controls</h3>
          <div id="profControls" style="display:none">
            <label>Professor: download attendance</label><br>
            <input id="profClassCode" placeholder="class code" />
            <input id="profDate" type="date" />
            <button id="profDownload">Download CSV</button>
          </div>
  
          <div id="officerControls" style="display:none">
            <label>Officer Reports</label><br>
            <select id="reportType"><option value="class_date">Class & Date</option><option value="person">Person</option><option value="week">Week</option><option value="semester">Whole Semester</option></select>
            <div id="reportParams" style="margin-top:8px"></div>
            <button id="generateReport">Generate</button>
            <div id="reportOutput" style="margin-top:8px"></div>
          </div>
    
          <div id="studentControls" style="display:none">
            <button id="viewMyAttendance">View My Attendance</button>
            <div id="myAttendanceOutput" style="margin-top:8px"></div>
          </div>
        </div>

        <!--
        <div class="card">
          <h3>Officers & Professors</h3>
          <div id="peopleList" class="small muted">Loading...</div>
        </div>
        -->
  
        <div class="card small muted"><strong>Notes:</strong> Check-in opens 10 minutes before class. On-time if checked-in within first 5 minutes; late if checked between 5 and 10 minutes; absent after 10 minutes and button is disabled.</div>
      </div>
    </div>
    
    <script>
      // CONFIG: set this to your deployed Apps Script WebApp URL
      const API_BASE = 'https://attendance-proxy.onrender.com/api';

      // Utility: call backend
      async function api(action, payload={}) {
        const body = Object.assign({action}, payload);
        const res = await fetch(API_BASE, {
          method:'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-requested-with': 'XMLHttpRequest'
          },
          body:JSON.stringify(body),
        });
        return res.json();
      }

      let currentUser = null; // {id, name, role}

      // submit on enter
      /*document.addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
          event.preventDefault();
          document.getElementById("loginBtn").click(); // triggers existing login button
        }
      });*/

      // login area only submit on enter
      document.getElementById("auth").addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          document.getElementById("signinBtn").click(); // correct id
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("loginForm");
        const idInput = document.getElementById("userId");
        const passwordInput = document.getElementById("passwordInput");
        const roleSelect = document.getElementById("roleSelect");
        const togglePassword = document.getElementById("togglePassword");
        const errorMsg = document.getElementById("errorMsg");
        const loginBtn = document.getElementById("loginBtn");
      
        // ‚úÖ Toggle password visibility
        togglePassword.addEventListener("click", () => {
          const isPassword = passwordInput.type === "password";
          passwordInput.type = isPassword ? "text" : "password";
          togglePassword.textContent = isPassword ? "üôà" : "üëÅÔ∏è";
        });
      
        // ‚úÖ Submit on Enter
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          errorMsg.textContent = "";
          loginBtn.disabled = true;
      
          const payload = {
            action: "signin",
            id: idInput.value.trim(),
            password: passwordInput.value.trim(),
            role: roleSelect.value
          };
      
          try {
            const res = await fetch("/api", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            const data = await res.json();
      
            if (!data.ok) {
              errorMsg.textContent = data.error || "Login failed";
              loginBtn.disabled = false;
              return;
            }
      
            // ‚úÖ Save session
            localStorage.setItem("user", JSON.stringify(data.user));
            window.location.href = "dashboard.html";
          } catch (err) {
            errorMsg.textContent = "Network error: " + err.message;
          } finally {
            loginBtn.disabled = false;
          }
        });
      });

      document.getElementById("hdr").innerHTML=new Date().toLocaleString("en-US", { dateStyle: 'full' });

      // Sign in
      document.getElementById('signinBtn').onclick = async ()=> {
        const id = document.getElementById('userId').value.trim();
        const pwd = document.getElementById('password').value;
        const role = document.getElementById('roleSelect').value;
        if (!id||!pwd) {document.getElementById('authMsg').textContent='Enter id and password';return}
        document.getElementById('authMsg').textContent='Signing in...';
        try {
          const r = await api('signin',{id, password:pwd, role});
          if (r.ok) {
            currentUser = r.user;
            localStorage.setItem('attendance_user', JSON.stringify(currentUser));
            showApp();
          } else {
          document.getElementById('authMsg').textContent = 'Sign in failed: '+r.error;
          }
        } catch(e) {document.getElementById('authMsg').textContent='Network error'}
      }

      // Sign out
      document.getElementById('signoutBtn').onclick = ()=> {
        currentUser=null;localStorage.removeItem('attendance_user');document.getElementById('app').style.display='none';document.getElementById('auth').style.display='block';
      }

       // On load, restore
      window.addEventListener('load', async ()=> {
        const raw = localStorage.getItem('attendance_user');
        if (raw) {currentUser=JSON.parse(raw);showApp();} else {document.getElementById('auth').style.display='block'}
        // pre-load schedule for today
      });

      async function showApp() {
        document.getElementById('auth').style.display='none';
        document.getElementById('app').style.display='block';
        document.getElementById('welcome').textContent = (currentUser.name || currentUser.id) ;
        document.getElementById('roleBadge').textContent = currentUser.role;
        // role-based controls
        document.getElementById('controls').style.display='block';
        document.getElementById('profControls').style.display = currentUser.role==='professor'?'block':'none';
        document.getElementById('officerControls').style.display = currentUser.role==='officer'?'block':'none';
        document.getElementById('studentControls').style.display = currentUser.role==='student'?'block':'none';
        // load people list
        /*const people = await api('list_people',{});
        if (people.ok) {
          document.getElementById('peopleList').innerHTML = people.html;
        }*/
        // load today's schedule
        loadTodaySchedule();
      }

      // load today's schedule and draw check-in buttons
      async function loadTodaySchedule() {
        document.getElementById('todayMsg').textContent='Loading...';
        const r = await api('today_schedule',{});
        if (!r.ok) {document.getElementById('todayMsg').textContent='Failed to load schedule';return}
        const schedule = r.schedule; // array of classes
        if (!schedule.length) {document.getElementById('todayMsg').textContent='No classes for today';document.getElementById('scheduleList').innerHTML='';return}
        document.getElementById('todayMsg').textContent='';
        const container = document.getElementById('scheduleList');container.innerHTML='';
        for (const cls of schedule) {
          // cls: {class_code, class_name, day, start_time, end_time, professor_id}
          const el = document.createElement('div');el.className='card';
          const h = document.createElement('div');h.innerHTML = `<strong>${cls.class_code} ‚Äî ${cls.class_name}</strong> <div class="small muted">${cls.start_time} ‚Äì ${cls.end_time} (${cls.day})</div>`;
          el.appendChild(h);
          const btn = document.createElement('button');btn.textContent='Check in';btn.disabled=true;btn.style.marginTop='8px';
          const statusSpan = document.createElement('div');statusSpan.className='small muted';statusSpan.style.marginTop='8px';
          el.appendChild(btn);el.appendChild(statusSpan);
    
          // attach update loop for enabling/disabling based on current time
          (function(cls, btn, statusSpan) {
            let iv; // interval reference so we can clear it later
          
            async function update() {
              const tzNow = new Date();
          
              // helper to parse "HH:MM"
              function parseTime(t) {
                const [hh, mm] = t.split(':').map(Number);
                const d = new Date(tzNow);
                d.setHours(hh, mm, 0, 0);
                return d;
              }
          
              const start = parseTime(cls.start_time);
              const enableFrom = new Date(start.getTime() - 10 * 60000);
              const lateAfter = new Date(start.getTime() + 5 * 60000);
              const absentAfter = new Date(start.getTime() + 10 * 60000);
          
              // check if already checked in
              const checkRes = await api('get_attendance', {
                class_code: cls.class_code,
                date: isoDate(tzNow),
                student_id: currentUser.id
              });

              // before checking time windows
              const localKey = `checkedin_${currentUser.id}_${cls.class_code}_${isoDate(tzNow)}`;
              if (localStorage.getItem(localKey)) {
                btn.disabled = true;
                statusSpan.textContent = 'Already checked in (saved locally)';
                clearInterval(iv);
                return;
              }
          
              let att = null;
              if (checkRes.ok) att = checkRes.record;
          
              if (att && att.status !== 'not_recorded') {
                btn.disabled = true;
                statusSpan.textContent = `Status: ${att.status} (checked at ${att.timestamp || '‚Äî'})`;
                clearInterval(iv); // ‚úÖ stop updating this card ‚Äî already checked in
              } else if (tzNow >= enableFrom && tzNow < absentAfter) {
                btn.disabled = false;
                if (tzNow < lateAfter)
                  statusSpan.textContent = 'On time window ‚Äî click to check in';
                else statusSpan.textContent = 'Late ‚Äî you will be tagged late if you check in now';
              } else if (tzNow >= absentAfter) {
                btn.disabled = true;
                statusSpan.textContent = 'Absent ‚Äî checkin disabled';
                clearInterval(iv);
              } else {
                btn.disabled = true;
                statusSpan.textContent = `Check-in opens at ${timeStr(enableFrom)}`;
              }
            }
          
            // initial run + start the timer
            update();
            iv = setInterval(update, 10000);
          
            // click handler
            btn.onclick = async () => {
              btn.disabled = true;
              statusSpan.textContent = 'Checking in...';
              const res = await api('checkin', {
                class_code: cls.class_code,
                student_id: currentUser.id
              });
              if (res.ok) {
                const key = `checkedin_${currentUser.id}_${cls.class_code}_${isoDate(new Date())}`;
                localStorage.setItem(key, 'true'); // ‚úÖ remember this check-in
                statusSpan.textContent = `Checked in: ${res.status} at ${res.timestamp}`;
                clearInterval(iv);
              } else {
                statusSpan.textContent = 'Checkin failed: ' + res.error;
                btn.disabled = false;
              }
            };
          })(cls, btn, statusSpan);

          container.appendChild(el);
        }
      }

      function isoDate(d){return d.toISOString().slice(0,10)}
      function timeStr(d){return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}

      // Professor download
      document.getElementById('profDownload').onclick = async ()=> {
        const class_code = document.getElementById('profClassCode').value.trim();
        const date = document.getElementById('profDate').value;
        if (!class_code||!date) return alert('enter class code and date');
        const r = await api('export_attendance',{class_code,date});
        if (r.ok && r.csv) {
          downloadCSV(r.csv, `${class_code}_${date}.csv`);
        } else alert('failed: '+(r.error||'no data'));
      }

      function downloadCSV(csv, filename) {
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
      }

      // Officer reports UI
      const reportParams = document.getElementById('reportParams');
      document.getElementById('reportType').onchange = ()=> {
        const v = document.getElementById('reportType').value;reportParams.innerHTML='';
        if (v==='class_date') {
          reportParams.innerHTML = `<input id='r_class' placeholder='class code' /> <input id='r_date' type='date' />`;
        } else if (v==='person') {
          reportParams.innerHTML = `<input id='r_person' placeholder='student id' /> <input id='r_from' type='date' /> <input id='r_to' type='date' />`;
        } else if (v==='week') {
          reportParams.innerHTML = `<input id='r_week_start' type='date' />`;
        } else if (v==='semester') {
          reportParams.innerHTML = `<input id='r_sem_start' type='date' /> <input id='r_sem_end' type='date' />`;
        }
      }

      document.getElementById('generateReport').onclick = async ()=> {
        const t = document.getElementById('reportType').value;const out = document.getElementById('reportOutput');out.innerHTML='Generating...';
        let payload={};
        if (t==='class_date') {payload={class_code:document.getElementById('r_class').value,date:document.getElementById('r_date').value}}
        else if (t==='person') {payload={student_id:document.getElementById('r_person').value, from:document.getElementById('r_from').value, to:document.getElementById('r_to').value}}
        else if (t==='week') {payload={week_start:document.getElementById('r_week_start').value}}
        else if (t==='semester') {payload={from:document.getElementById('r_sem_start').value,to:document.getElementById('r_sem_end').value}}
        const r = await api('report',{type:t, ...payload});
        if (r.ok && r.csv) {
          out.innerHTML = `<a href='#' id='dl'>Download CSV</a>`;
          document.getElementById('dl').onclick = ()=>{downloadCSV(r.csv,'report.csv')}
        } else out.innerHTML = 'No results or error: '+(r.error||'')
      }

      // Student view my attendance
      document.getElementById('viewMyAttendance').onclick = async ()=> {
        const out = document.getElementById('myAttendanceOutput');out.textContent='Loading...';
        const r = await api('my_attendance',{student_id:currentUser.id});
        if (r.ok && r.csv) {
          out.innerHTML = `<a href='#' id='dl2'>Download my attendance (CSV)</a>`;
          document.getElementById('dl2').onclick = ()=>{downloadCSV(r.csv,'my_attendance.csv')}
        } else out.textContent='No data';
      }
    </script>
  </body>
</html>
