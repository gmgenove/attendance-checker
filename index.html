<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendance Checker</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 0; background: #f9f9fb; }
      header { background: #2563eb; color: #fff; padding: 1rem; text-align: center; }
      .container { max-width: 800px; margin: 2rem auto; background: #fff; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
      .hidden { display: none; }
      table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
      th, td { padding: 0.75rem; border-bottom: 1px solid #ddd; text-align: center; }
      button { background: #2563eb; color: white; padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; }
      button:disabled { background: #ccc; cursor: not-allowed; }
      .logout { background: #ef4444; float: right; }
    </style>
  </head>
  <body>
    <header>
      <h2>Attendance Checker</h2>
    </header>
    <div class="container">
      <div id="login">
        <h3>Login</h3>
        <input type="text" id="student_id" placeholder="Student ID" /><br><br>
        <input type="password" id="password" placeholder="Password" /><br><br>
        <button onclick="signin()">Sign In</button>
        <p id="loginError" style="color:red;"></p>
      </div>
      <div id="dashboard" class="hidden">
        <h3>Welcome, <span id="userName"></span></h3>
        <button class="logout" onclick="logout()">Logout</button>
        <p>Todayâ€™s Classes:</p>
        <table id="scheduleTable">
          <thead><tr><th>Class</th><th>Time</th><th>Status</th><th>Action</th></tr></thead>
          <tbody></tbody>
        </table>
        <div id="reports" class="hidden">
          <h4>Reports</h4>
          <button onclick="generateReport('class')">By Class</button>
          <button onclick="generateReport('date')">By Date</button>
          <button onclick="generateReport('student')">By Student</button>
          <button onclick="generateReport('week')">By Week</button>
          <button onclick="generateReport('semester')">Full Semester</button>
        </div>
      </div>
    </div>
    <script>
      const res = await fetch(`${API_BASE}?action=signin&student_id=${id}&password=${pw}`);
      const data = await res.json();
      if (data.success) {
        user = data.user;
        document.getElementById('login').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('userName').textContent = user.name;
        if (user.role !== 'student') document.getElementById('reports').classList.remove('hidden');
        loadSchedule();
      } else {
        document.getElementById('loginError').textContent = 'Invalid credentials';
      }

      function logout() {
        user = null;
        document.getElementById('dashboard').classList.add('hidden');
        document.getElementById('login').classList.remove('hidden');
      }

      async function loadSchedule() {
        const res = await fetch(`${API_BASE}?action=today_schedule&student_id=${user.student_id}`);
        const data = await res.json();
        const tbody = document.querySelector('#scheduleTable tbody');
        tbody.innerHTML = '';
        data.classes.forEach(cls => {
          const tr = document.createElement('tr');
          const now = new Date();
          const start = new Date(`${now.toDateString()} ${cls.start_time}`);
          const diff = (start - now) / 60000; // minutes
          let status = 'Upcoming';
          let disabled = false;
          if (diff <= 10 && diff >= -10) status = 'Open';
          else if (diff < -10) { status = 'Closed'; disabled = true; }
    
          tr.innerHTML = `<td>${cls.class_name}</td><td>${cls.start_time}</td><td>${status}</td><td><button ${disabled?'disabled':''} onclick=checkin('${cls.class_code}')>Check In</button></td>`;
          tbody.appendChild(tr);
        });
      }

      async function checkin(class_code) {
        const res = await fetch(`${API_BASE}?action=checkin&student_id=${user.student_id}&class_code=${class_code}`);
        const data = await res.json();
        alert(data.message);
        loadSchedule();
      }
      
      async function generateReport(type) {
        const res = await fetch(`${API_BASE}?action=report&type=${type}`);
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `attendance_${type}.csv`;
        a.click();
      }
    </script>
  </body>
</html>
