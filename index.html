<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <title>BPAOUMN 1-B Attendance Checker</title>
    <style>
      /* Minimal clean styling */
      body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;padding:16px;background:#f7fafc;color:#0f172a}
      .container{max-width:900px;margin:0 auto}
      header{display:flex;align-items:center;justify-content:space-between}
      .card{background:white;border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
      input,select,button{padding:10px;border-radius:8px;border:1px solid #e2e8f0}
      button{cursor:pointer}
      .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
      table{width:100%;border-collapse:collapse}
      th,td{padding:8px;border-bottom:1px solid #edf2f7;text-align:left}
      .small{font-size:0.9rem;color:#475569}
      .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#e6f4ea;color:#064e3b}
      .danger{background:#fff1f2;color:#7f1d1d}
      .muted{color:#94a3b8}

      .login-card {
        max-width: 300px;
        margin: 40px auto;
        padding: 20px;
        border-radius: 12px;
        background: #f9f9f9;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
      .form-group {
        margin-bottom: 15px;
      }
      .password-wrapper {
        display: flex;
        align-items: center;
      }
      .password-wrapper input {
        /*flex: 1;*/
      }
      .field-icon {
		float: right;
        margin-left: -25px;
		position: relative;
		z-index: 2;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.1em;
      }
      .error-message {
        color: #d93025; /* Google-style red */
        margin-top: 10px;
        font-size: 0.9em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>BPAOUMN 1-B Attendance Checker</h1>
        <div id="hdr" class="small muted"></div>
      </header>

      <div id="auth" class="card">
        <h3 id="formTitle">Sign In</h3>
        <form id="authForm">
			<div class="grid">
			  <div>
				<label for="userId">Student ID / Officer / Professor ID</label><br>
				<input id="userId" placeholder="e.g. 2025-XXXXXX-MN-X" required />
			  </div>
			  <div class="form-group">
				<label for="passwordInput">Password</label><br>
				<div class="password-wrapper">
				  <input id="passwordInput" type="password" placeholder="Enter your password" required><span id="togglePassword" class="fa fa-fw fa-eye field-icon"></span></input>
				</div>
			  </div>
			</div>
			<div style="margin-top:12px">
			  <label for="roleSelect">Role</label>
			  <select id="roleSelect">
				<option value="">Select Role</option>
				<option value="student">Student</option>
				<option value="officer">Officer</option>
				<option value="professor">Professor</option>
			  </select>
			  <button type="submit" id="submitBtn">Sign In</button>
			  <p id="switchText" class="small">Don’t have an account? <a href="#">Sign up</a></p>
			</div>
			<div id="authMsg" class="small muted"></div>
			<div id="errorMsg" class="error-message"></div>
        </form>
      </div>
      
      <div id="app" style="display:none">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <strong id="welcome"></strong>
              <div class="small muted" id="roleBadge"></div>
            </div>
            <div>
              <button id="signoutBtn">Sign out</button>
            </div>
          </div>
        </div>

        <div class="card" id="todayScheduleCard">
          <h3>Today's Schedule</h3>
          <div id="todayMsg" class="small muted">Loading schedule...</div>
          <div id="scheduleList"></div>
        </div>
  
        <div class="card" id="controls" style="display:none">
          <h3>Controls</h3>
          <div id="profControls" style="display:none">
            <label>Professor: download attendance</label><br>
            <input id="profClassCode" placeholder="class code" />
            <input id="profDate" type="date" />
            <button id="profDownload">Download CSV</button>
          </div>
			
          <div id="officerControls" style="display:none">
            <label>Officer Reports</label><br>
            <select id="reportType">
				<option value="class_date">Class & Date</option>
				<option value="person">Person</option>
				<option value="week">Week</option>
				<option value="semester">Whole Semester</option>
			</select>
            <div id="reportParams" style="margin-top:8px"></div>
            <button id="generateReport">Generate</button>
            <div id="reportOutput" style="margin-top:8px"></div>

			<hr style="margin:12px 0" />
			<button id="runAutoTag" style="margin-top:10px;background:#0f766e;color:white">
				Run Auto-Tag Absentees Now
			</button>
			<div id="autoTagMsg" class="small muted" style="margin-top:8px"></div>
          </div>
    
          <div id="studentControls" style="display:none">
            <button id="viewMyAttendance">View My Attendance</button>
            <div id="myAttendanceOutput" style="margin-top:8px"></div>
          </div>
        </div>

        <!--
        <div class="card">
          <h3>Officers & Professors</h3>
          <div id="peopleList" class="small muted">Loading...</div>
        </div>
        -->
  
        <div class="card small muted">
			<strong>Notes:</strong> Check-in opens 10 minutes before class. On-time if checked-in within first 5 minutes; late if checked between 5 and 10 minutes; absent after 10 minutes and button is disabled.
		</div>
      </div>
    </div>
    
    <script>
      // CONFIG: set this to your deployed Apps Script WebApp URL
      const API_BASE = 'https://attendance-proxy.onrender.com/api';

      // Utility: call backend safely
	  async function api(action, payload = {}) {
	    const body = { action, ...payload };
	    try {
	      const res = await fetch(API_BASE, {
	        method: "POST",
	        headers: { "Content-Type": "application/json" },
	        body: JSON.stringify(body),
	      });
	
	      const text = await res.text();
	
	      // Empty or non-JSON response → return structured error
	      if (!text.trim()) {
	        console.error("Empty response from backend for", action);
	        return { ok: false, error: "Empty response from server" };
	      }
	
	      try {
	        return JSON.parse(text);
	      } catch (err) {
	        console.error("Invalid JSON:", text);
	        // Try to extract readable error if HTML
	        const match = text.match(/<title>(.*?)<\/title>/i);
	        return {
	          ok: false,
	          error:
	            "Invalid JSON from server" +
	            (match ? ` (${match[1]})` : ""),
	          raw: text,
	        };
	      }
	    } catch (err) {
	      console.error("Network error", err);
	      return { ok: false, error: "Network error: " + err.message };
	    }
	  }

      let currentUser = null; // {id, name, role}

      // login area only submit on enter
      document.getElementById("auth").addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          document.getElementById("submitBtn").click(); // correct id
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("authForm");
        const idInput = document.getElementById("userId");
        const passwordInput = document.getElementById("passwordInput");
        const roleSelect = document.getElementById("roleSelect");
        const togglePassword = document.getElementById("togglePassword");
        const errorMsg = document.getElementById("errorMsg");
        const submitBtn = document.getElementById("submitBtn");
		const formTitle = document.getElementById("formTitle");
		const switchText = document.getElementById("switchText");

		let isSignup = false;

        // Toggle password visibility
        togglePassword.addEventListener("click", () => {
          const isPassword = passwordInput.type === "password";
          passwordInput.type = isPassword ? "text" : "password";
          if (isPassword) {
			document.getElementById("togglePassword").classList.remove("fa-eye");
			document.getElementById("togglePassword").classList.add("fa-eye-slash");
		  } else {
			document.getElementById("togglePassword").classList.remove("fa-eye-slash");
			document.getElementById("togglePassword").classList.add("fa-eye");
		  }
        });

		// Toggle between Sign In / Sign Up
		switchText.addEventListener("click", (e) => {
		  e.preventDefault();
		  isSignup = !isSignup;
		  formTitle.textContent = isSignup ? "Sign Up" : "Sign In";
		  submitBtn.textContent = isSignup ? "Sign Up" : "Sign In";
		  switchText.innerHTML = isSignup
			? 'Already have an account? <a href="#">Sign in</a>'
			: 'Don’t have an account? <a href="#">Sign up</a>';
		  errorMsg.textContent = "";
		});
      
        // Handle form submit
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          errorMsg.textContent = "";
          submitBtn.disabled = true;
		  
          if (!idInput.value.trim()||!passwordInput.value.trim()) {
			document.getElementById('errorMsg').textContent='Enter id and password';
			document.getElementById('authMsg').textContent='';
			return;
          }
		  if (!roleSelect.value) {
			document.getElementById('errorMsg').textContent='Select role';
			document.getElementById('authMsg').textContent='';
			return;
          }
		  document.getElementById('authMsg').textContent = isSignup ? "Signing up..." : "Signing in...";
      
          try {
			const data = await api(isSignup ? "signup" : "signin", {
			  id: idInput.value.trim(),
			  password: passwordInput.value.trim(),
			  role: roleSelect.value
			});
      
            if (!data.ok) {
              errorMsg.textContent = data.error ? data.error : isSignup ? "Signup failed" : "Login failed";
			  document.getElementById('authMsg').textContent='';
              submitBtn.disabled = false;
              return;
            }

			if (isSignup) {
		      errorMsg.style.color = "green";
		      errorMsg.textContent = data.message || "Signup successful!";
		      isSignup = false;
		      formTitle.textContent = "Sign In";
		      submitBtn.textContent = "Sign In";
	      	} else { // ✅ Save session
			  currentUser = data.user;
	          localStorage.setItem("currentUser", JSON.stringify(currentUser));
			  showApp();
		    }
          } catch (err) {
            errorMsg.textContent = "Network error: " + err.message;
          } finally {
            submitBtn.disabled = false;
			setTimeout(() => {
			  document.getElementById('authMsg').textContent = "";
			}, 6000);
          }
        });
      });

      document.getElementById("hdr").innerHTML=new Date().toLocaleString("en-US", { dateStyle: 'full' });

      // Sign out
      document.getElementById('signoutBtn').onclick = ()=> {
        currentUser=null;localStorage.removeItem('currentUser');document.getElementById('app').style.display='none';document.getElementById('auth').style.display='block';document.getElementById('authMsg').textContent='';
      }

       // On load, restore
      window.addEventListener('load', async ()=> {
        const raw = localStorage.getItem('currentUser');
        if (raw) {
		  try {
			currentUser=JSON.parse(raw);
			showApp();
		  } catch (e) {
			localStorage.removeItem('currentUser');
		  }
		} else {
		  document.getElementById('auth').style.display='block';
		}
        // pre-load schedule for today
      });

	  // Officer: Manually trigger auto-tag absentees and auto-refresh attendance
	  const runAutoTagBtn = document.getElementById('runAutoTag');
		if (runAutoTagBtn) {
		  runAutoTagBtn.addEventListener('click', async () => {
		  const msg = document.getElementById('autoTagMsg');
		  msg.textContent = "Running absentee tagging...";
		  runAutoTagBtn.disabled = true;
		  
		  // Disable button and show loading text
		  runAutoTagBtn.disabled = true;
		  runAutoTagBtn.textContent = "Tagging absentees...";
		  msg.textContent = "";
		  msg.style.color = "";

		  try {
			const res = await api('auto_tag_absentees', {});
			if (res.ok) {
			  msg.textContent = res.message || "Absentees tagged successfully.";
				
			  // Optional: give user feedback visually
			  msg.style.color = "green";
			  setTimeout(() => msg.style.color = "", 3000);

			  // 🔁 Auto-refresh attendance data if officer is viewing it
			  if (typeof loadTodaySchedule === "function") {
			    await loadTodaySchedule(); // refresh schedule list if visible
			  }

			  // If officer has an attendance view or report open, reload it too
			  const reportOutput = document.getElementById("reportOutput");
			  if (reportOutput && reportOutput.innerHTML.trim() !== "") {
			    // re-generate the current report type automatically
			    const reportType = document.getElementById("reportType").value;
			    const genBtn = document.getElementById("generateReport");
			    if (genBtn) genBtn.click();
			  }

			} else {
		      msg.textContent = "Failed: " + (res.error || "Unknown error");
			  msg.style.color = "red";
			}
		  } catch (err) {
			console.error("Auto tag error:", err);
			msg.textContent = "Network error: " + err.message;
			msg.style.color = "red";
		  } finally {
			// Re-enable button and reset text
			runAutoTagBtn.disabled = false;
			runAutoTagBtn.textContent = "Run Auto-Tag Absentees Now";
			setTimeout(() => {
			  msg.textContent = "";
			}, 6000);
		  }
		});
	  }

      async function showApp() {
        document.getElementById('auth').style.display='none';
        document.getElementById('app').style.display='block';
        document.getElementById('welcome').textContent = (currentUser.name || currentUser.id) ;
        document.getElementById('roleBadge').textContent = currentUser.role;
        // role-based controls
        document.getElementById('controls').style.display='block';
        document.getElementById('profControls').style.display = currentUser.role==='professor'?'block':'none';
        document.getElementById('officerControls').style.display = currentUser.role==='officer'?'block':'none';
        document.getElementById('studentControls').style.display = currentUser.role==='student'?'block':'none';
        // load people list
        /*const people = await api('list_people',{});
        if (people.ok) {
          document.getElementById('peopleList').innerHTML = people.html;
        }*/
        // load today's schedule
        loadTodaySchedule();
      }

      // load today's schedule and draw check-in buttons
      async function loadTodaySchedule() {
		document.getElementById('todayMsg').textContent = 'Loading...';
		const r = await api('today_schedule', {});
		if (!r.ok) { document.getElementById('todayMsg').textContent = 'Failed to load schedule'; return; }
		  const schedule = r.schedule;
		  if (!schedule.length) { document.getElementById('todayMsg').textContent = 'No classes for today'; document.getElementById('scheduleList').innerHTML = ''; return; }
		  document.getElementById('todayMsg').textContent = '';
		  const container = document.getElementById('scheduleList'); container.innerHTML = '';
		
		  for (const cls of schedule) {
		    const el = document.createElement('div'); el.className = 'card';
		    const h = document.createElement('div');
		    h.innerHTML = `<strong>${cls.class_code} — ${cls.class_name}</strong> 
		                   <div class="small muted">${cls.start_time} – ${cls.end_time} (${cls.day})</div>`;
		    el.appendChild(h);
		
		    const btnCheckin = document.createElement('button'); btnCheckin.textContent = 'Check in'; btnCheckin.disabled = true; btnCheckin.style.marginTop = '8px';
		    const btnCredit = document.createElement('button'); btnCredit.textContent = 'Credit'; btnCredit.style.marginLeft = '6px';
		    const btnExcuse = document.createElement('button'); btnExcuse.textContent = 'Excuse'; btnExcuse.style.marginLeft = '6px';
			const reasonField = document.createElement('input');
			reasonField.type = 'text';
			reasonField.placeholder = 'Reason for excuse';
			reasonField.style.display = 'none';
			reasonField.style.marginTop = '6px';
		    const statusSpan = document.createElement('div'); statusSpan.className = 'small muted'; statusSpan.style.marginTop = '8px';
		
		    el.appendChild(btnCheckin);
		    el.appendChild(btnCredit);
		    el.appendChild(btnExcuse);
			el.appendChild(reasonField);
		    el.appendChild(statusSpan);
		
		    // Time-based enabling logic for check-in
		    (function (cls, btnCheckin, statusSpan) {
		      let iv;
		      async function update() {
		        const tzNow = new Date();
		        function parseTime(t) {
		          const [hh, mm] = t.split(':').map(Number);
		          const d = new Date(tzNow);
		          d.setHours(hh, mm, 0, 0);
		          return d;
		        }
		        const start = parseTime(cls.start_time);
		        const enableFrom = new Date(start.getTime() - 10 * 60000);
		        const lateAfter = new Date(start.getTime() + 5 * 60000);
		        const absentAfter = new Date(start.getTime() + 10 * 60000);
		
		        const checkRes = await api('get_attendance', {
		          class_code: cls.class_code,
		          date: isoDate(tzNow),
		          student_id: currentUser.id
		      });
		
		      const localKey = `checkedin_${currentUser.id}_${cls.class_code}_${isoDate(tzNow)}`;
		      if (localStorage.getItem(localKey)) {
		        btnCheckin.disabled = true;
		        statusSpan.textContent = 'Already checked in (saved locally)';
		        clearInterval(iv);
		        return;
		      }
		
		      let att = null;
		      if (checkRes.ok) att = checkRes.record;
		
		      if (att && att.status !== 'not_recorded') {
		        btnCheckin.disabled = true;
		        statusSpan.textContent = `Status: ${att.status} (${att.timestamp || '—'})`;
		        clearInterval(iv);
		      } else if (tzNow >= enableFrom && tzNow < absentAfter) {
		        btnCheckin.disabled = false;
		        if (tzNow < lateAfter)
		          statusSpan.textContent = 'On time window — click to check in';
		        else statusSpan.textContent = 'Late — you will be tagged late if you check in now';
		      } else if (tzNow >= absentAfter) {
		        btnCheckin.disabled = true;
		        statusSpan.textContent = 'Absent — check-in disabled';
		        clearInterval(iv);
		      } else {
		        btnCheckin.disabled = true;
		        statusSpan.textContent = `Check-in opens at ${timeStr(enableFrom)}`;
		      }
		    }
		
		    update();
		    iv = setInterval(update, 10000);
		
		    btnCheckin.onclick = async () => {
		      btnCheckin.disabled = true;
		      statusSpan.textContent = 'Checking in...';
		      const res = await api('checkin', { class_code: cls.class_code, student_id: currentUser.id });
		      if (res.ok) {
		        const key = `checkedin_${currentUser.id}_${cls.class_code}_${isoDate(new Date())}`;
		        localStorage.setItem(key, 'true');
		        statusSpan.textContent = `Checked in: ${res.status} at ${res.timestamp}`;
		        clearInterval(iv);
		      } else {
		        statusSpan.textContent = 'Check-in failed: ' + res.error;
		        btnCheckin.disabled = false;
		      }
		    };
		  })(cls, btnCheckin, statusSpan);
		  
		  // Hide Credit button if outside adjustment period
		  const config = await api('get_adjustment_period', {});
		  if (!config.ok || new Date() > new Date(config.adjustEnd)) {
			btnCredit.style.display = 'none';
		  }
		  
		  const attCheck = await api('get_attendance', {
			class_code: cls.class_code,
			date: isoDate(new Date()),
			student_id: currentUser.id
		  });

		  let att = null;
		  if (attCheck.ok) att = attCheck.record;

		  // Hide or disable buttons based on status
		  if (att && att.status === 'CREDITED') {
			btnCredit.disabled = true;
		    btnExcuse.style.display = 'none'; // hide Excuse
			statusSpan.textContent = '✅ Credited';
		  } else if (att && att.status === 'EXCUSE') {
			btnExcuse.disabled = true;
			btnCredit.style.display = 'none'; // hide Credit
			statusSpan.textContent = '🟡 Excuse';
		  }
		
		  // ✅ Credit Button
		  btnCredit.onclick = async () => {
		    if (!confirm('Credit attendance for the whole semester?')) return;
		    const res = await api('credit_attendance', { class_code: cls.class_code, student_id: currentUser.id });
		    if (res.ok) {
			  statusSpan.textContent = '✅ Credited';
			  btnCredit.disabled = true;
			  btnExcuse.disabled = true;
			} else alert('❌ ' + res.error);
		  };
		
		  // ✅ Excuse Button
		  btnExcuse.onclick = () => {
			reasonField.style.display = reasonField.style.display === 'none' ? 'block' : 'none';
		  };
		  reasonField.onchange = async () => {
			const res = await api('excuse_attendance', {
			  class_code: cls.class_code, 
			  student_id: currentUser.id, 
			  reason: reasonField.value
			});
			if (res.ok) {
			  statusSpan.textContent = '🟡 Excuse';
			  btnExcuse.disabled = true;
			  btnCredit.disabled = true;
			} else alert('❌ ' + res.error);
		  };
		  btnExcuse.onclick = async () => {
		    const reason = prompt('Enter reason for excuse:');
		    if (!reason) return alert('Reason is required.');
		    const res = await api('excuse_attendance', { class_code: cls.class_code, student_id: currentUser.id, reason });
		    if (res.ok) alert('✅ ' + res.message);
		    else alert('❌ ' + res.error);
		  };
		
		  container.appendChild(el);
		}
	  }

      function isoDate(d){return d.toISOString().slice(0,10)}
      function timeStr(d){return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}

      // Professor download
      document.getElementById('profDownload').onclick = async ()=> {
        const class_code = document.getElementById('profClassCode').value.trim();
        const date = document.getElementById('profDate').value;
        if (!class_code||!date) return alert('enter class code and date');
        const r = await api('export_attendance',{class_code,date});
        if (r.ok && r.csv) {
          downloadCSV(r.csv, `${class_code}_${date}.csv`);
        } else alert('failed: '+(r.error||'no data'));
      }

      function downloadCSV(csv, filename) {
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
      }

      // Officer reports UI
      const reportParams = document.getElementById('reportParams');
      document.getElementById('reportType').onchange = ()=> {
        const v = document.getElementById('reportType').value;reportParams.innerHTML='';
        if (v==='class_date') {
          reportParams.innerHTML = `<input id='r_class' placeholder='class code' /> <input id='r_date' type='date' />`;
        } else if (v==='person') {
          reportParams.innerHTML = `<input id='r_person' placeholder='student id' /> <input id='r_from' type='date' /> <input id='r_to' type='date' />`;
        } else if (v==='week') {
          reportParams.innerHTML = `<input id='r_week_start' type='date' />`;
        } else if (v==='semester') {
          reportParams.innerHTML = `<input id='r_sem_start' type='date' /> <input id='r_sem_end' type='date' />`;
        }
      }

      document.getElementById('generateReport').onclick = async ()=> {
        const t = document.getElementById('reportType').value;const out = document.getElementById('reportOutput');out.innerHTML='Generating...';
        let payload={};
        if (t==='class_date') {payload={class_code:document.getElementById('r_class').value,date:document.getElementById('r_date').value}}
        else if (t==='person') {payload={student_id:document.getElementById('r_person').value, from:document.getElementById('r_from').value, to:document.getElementById('r_to').value}}
        else if (t==='week') {payload={week_start:document.getElementById('r_week_start').value}}
        else if (t==='semester') {payload={from:document.getElementById('r_sem_start').value,to:document.getElementById('r_sem_end').value}}
        const r = await api('report',{type:t, ...payload});
        if (r.ok && r.csv) {
          out.innerHTML = `<a href='#' id='dl'>Download CSV</a>`;
          document.getElementById('dl').onclick = ()=>{downloadCSV(r.csv,'report.csv')}
        } else out.innerHTML = 'No results or error: '+(r.error||'')
      }

      // Student view my attendance
      document.getElementById('viewMyAttendance').onclick = async () => {
		const out = document.getElementById('myAttendanceOutput');
		out.textContent = 'Loading...';

		try {
		  const res = await api('my_attendance', { student_id: currentUser.id });

		  if (res.ok) {
			out.textContent = ''; // clear "Loading..."
			  
			// Create and show a download link dynamically
			const pdfBlobUrl = 'data:application/pdf;base64,' + res.pdf;
		    const link = document.createElement('a');
			link.href = pdfBlobUrl;
			link.download = res.filename;
			link.textContent = '📄 Download Attendance PDF';
			link.style.display = 'inline-block';
			link.style.marginTop = '10px';
			link.style.color = '#007bff';
			link.style.textDecoration = 'underline';
			link.style.cursor = 'pointer';
			out.innerHTML = '';
			out.appendChild(link);
		  } else {
			out.textContent = 'No data: ' + res.error;
			alert('❌ ' + res.error);
		  }
		} catch (err) {
			out.textContent = 'Error fetching attendance.';
			alert('⚠️ ' + err.message);
		}
	  };
    </script>
  </body>
</html>
