<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Section Attendance Checker</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
      body{font-family:system-ui,Segoe UI,Roboto;max-width:900px;margin:18px auto;padding:12px}
      header{display:flex;justify-content:space-between;align-items:center}
      .card{border:1px solid #e8e8e8;padding:12px;border-radius:8px;margin:8px 0}
      button{padding:8px 12px;border-radius:6px;border:1px solid #bbb;background:#fff;cursor:pointer}
      table{width:100%;border-collapse:collapse}
      td,th{padding:6px;border-bottom:1px solid #eee}
      .small{font-size:0.9rem;color:#555}
    </style>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>
  <body>
    <header>
      <h2>Attendance — Section Daily Schedule</h2>
      <div id="auth">
        <div id="g_id_onload" data-client_id="GOOGLE_CLIENT_ID_REPLACE" data-auto_prompt="false"></div>
        <div id="buttonDiv"></div>
        <div id="userInfo" style="display:none"></div>
      </div>
    </header>
    
    <section class="card">
      <h3>Today's classes</h3>
      <div id="schedule">Loading...</div>
    </section>
    
    <section class="card">
      <h3>My Attendance</h3>
      <div id="myAttendance">Sign in to view your attendance.</div>
    </section>
    
    <section class="card">
      <h3>Reports & Downloads (Officers / Professors)</h3>
      <div id="reportControls" style="display:none">
        <label>Class ID: <input id="r_class" /></label>
        <label>Date (yyyy-mm-dd): <input id="r_date" /></label>
        <label>Student email: <input id="r_person" /></label>
        <button id="genReport">Generate CSV</button>
        <a id="downloadLink" style="display:none">Download CSV</a>
        <div id="reportMsg" class="small"></div>
      </div>
      <div id="roles" class="small"></div>
    </section>
    
    <script>
      const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxPJSGmcHtLrWK0wqdQvQHKSAqmeL2-ooyUbFWX8BiDL25mVaRjyh80HqGATXMmsFGd/exec'; // example: https://script.google.com/macros/s/AKfycb.../exec
      const GOOGLE_CLIENT_ID = '526576718821-09ggsafkqv5005cus38q7u0s1ld6mcg0.apps.googleusercontent.com'; // oauth client id
      let idToken = null;
      let userEmail = null;
      let userRole = null;
    
      function handleCredentialResponse(response) {
        if (!response || !response.credential) return;
        idToken = response.credential;
        // Verify token by calling a lightweight endpoint (getTodaySchedule returns schedule or error)
        apiPost('api.getTodaySchedule', {id_token: idToken}).then(r => {
          if (r.ok) {
            userEmail = r.schedule ? r.schedule.length ? '(signed)' : '(signed)' : '(signed)';
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('userInfo').innerText = 'Signed in';
            // load data
            loadTodaySchedule();
            loadMyAttendance();
            loadRolesList();
          } else {
            alert('Sign-in failed: ' + (r.error || r.message));
          }
        }).catch(err => alert('Error contacting server: ' + err));
      }
    
      function apiPost(action, body) {
        const payload = Object.assign({}, {action: action}, body || {});
        return fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        }).then(r => r.json());
      }
    
      function loadTodaySchedule() {
        apiPost('api.getTodaySchedule', {id_token: idToken}).then(res => {
          if (!res.ok) return alert('Error: ' + res.error);
          renderSchedule(res.schedule);
        });
      }
    
      function renderSchedule(list) {
        const el = document.getElementById('schedule');
        if (!list || list.length === 0) {
          el.innerText = 'No classes today for your section.';
          return;
        }
        const now = new Date();
        el.innerHTML = '';
        list.forEach(item => {
          const card = document.createElement('div');
          card.className = 'card';
          const title = document.createElement('div');
          title.innerHTML = `<strong>${item.class_name}</strong> <span class="small">(${item.class_id})</span>`;
          const times = document.createElement('div');
          times.className = 'small';
          times.innerText = `${item.start_time} - ${item.end_time} | Prof: ${item.professor_email}`;
          const btn = document.createElement('button');
          btn.textContent = 'Check-in';
          btn.onclick = () => doCheckin(item.class_id, btn);
          // UX: disable/enable based on local clock (server still enforces)
          const parts = item.start_time.split(':');
          const startDt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(parts[0]), parseInt(parts[1]));
          const openStart = new Date(startDt.getTime() - 10*60*1000);
          const absentAt = new Date(startDt.getTime() + 10*60*1000);
          if (now < openStart) {
            btn.disabled = true;
            btn.textContent = 'Opens at ' + openStart.toLocaleTimeString();
          } else if (now >= absentAt) {
            btn.disabled = true;
            btn.textContent = 'Absent (disabled)';
          }
          card.appendChild(title);
          card.appendChild(times);
          card.appendChild(btn);
          el.appendChild(card);
        });
      }
    
      function doCheckin(class_id, btn) {
        btn.disabled = true;
        btn.textContent = 'Checking...';
        apiPost('api.checkIn', {id_token: idToken, class_id: class_id})
          .then(res => {
            if (res.ok) {
              btn.textContent = 'Checked: ' + res.status;
              loadMyAttendance();
            } else {
              alert('Check-in failed: ' + res.error);
              btn.disabled = false;
              btn.textContent = 'Check-in';
              loadTodaySchedule();
            }
          }).catch(err => {
            alert('Network error: ' + err);
          });
      }
    
      function loadMyAttendance() {
        apiPost('api.getMyAttendance', {id_token: idToken}).then(res => {
          if (!res.ok) return;
          renderMyAttendance(res.attendance);
        });
      }
    
      function renderMyAttendance(list) {
        const el = document.getElementById('myAttendance');
        if (!list || list.length === 0) {
          el.innerText = 'No attendance records yet.';
          return;
        }
        const tbl = document.createElement('table');
        const header = document.createElement('tr');
        header.innerHTML = '<th>Date</th><th>Class</th><th>Status</th><th>Check-in</th>';
        tbl.appendChild(header);
        list.forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${r.date}</td><td>${r.class_id}</td><td>${r.status}</td><td>${r.checkin_time}</td>`;
          tbl.appendChild(tr);
        });
        el.innerHTML = '';
        el.appendChild(tbl);
      }
    
      function loadRolesList() {
        apiPost('api.getRolesList', {id_token: idToken}).then(res => {
          if (!res.ok) return;
          const roles = res.roles || [];
          const profs = roles.filter(x => x.role && x.role.toLowerCase() === 'professor').map(x => x.email);
          const offs = roles.filter(x => x.role && x.role.toLowerCase() === 'officer').map(x => x.email);
          document.getElementById('roles').innerHTML = '<strong>Professors:</strong> ' + profs.join(', ') + '<br/><strong>Officers:</strong> ' + offs.join(', ');
          // show report controls if current user is officer/professor
          const meRow = roles.find(x => x.email && x.email.toLowerCase() === (idToken ? '' : ''));
          // Instead of relying on above, ask server for role by reusing token (server enforced)
          apiPost('api.getRolesList', {id_token: idToken}).then(r2 => {
            // find my role
            const myRole = (r2.roles || []).find(x => x.email && x.email.toLowerCase() === (r2.roles && r2.roles.length ? (r2.roles.find(i=>true).email) : ''));
            // simpler: request generateReport later and server will enforce
          });
          // show controls — server will still block unauthorized requests
          document.getElementById('reportControls').style.display = 'block';
        });
      }
    
      document.getElementById('genReport').onclick = function(){
        const params = {
          class_id: document.getElementById('r_class').value,
          date: document.getElementById('r_date').value,
          person_email: document.getElementById('r_person').value
        };
        apiPost('api.generateReport', {id_token: idToken, params: params}).then(res => {
          if (!res.ok) {
            alert('Report error: ' + res.error);
            return;
          }
          const csv = res.csv || '';
          if (!csv) {
            document.getElementById('reportMsg').innerText = 'No data for selected filters.';
            return;
          }
          const blob = new Blob([csv], {type:'text/csv'});
          const url = URL.createObjectURL(blob);
          const link = document.getElementById('downloadLink');
          link.href = url;
          link.download = 'attendance_report.csv';
          link.style.display = 'inline';
          link.textContent = 'Download CSV';
          document.getElementById('reportMsg').innerText = 'Report ready.';
        });
      };
    
      // Google Identity button render
      window.onload = function() {
        google.accounts.id.initialize({client_id: GOOGLE_CLIENT_ID, callback: handleCredentialResponse});
        google.accounts.id.renderButton(document.getElementById('buttonDiv'), {theme:'outline', size:'medium'});
      };
    </script>
  </body>
</html>
