<!-- Index.html -->
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Section Attendance Checker</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
      body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;max-width:900px;margin:18px auto;padding:12px}
      header{display:flex;justify-content:space-between;align-items:center}
      .card{border:1px solid #e0e0e0;padding:12px;border-radius:8px;margin:8px 0}
      button{padding:8px 12px;border-radius:6px;border:1px solid #bbb;background:#fff;cursor:pointer}
      button.primary{background:#0b7df0;color:white;border:0}
      table{width:100%;border-collapse:collapse}
      td,th{padding:6px;border-bottom:1px solid #eee}
      .small{font-size:0.9rem;color:#555}
    </style>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>
  <body>
    <header>
      <h2>Attendance â€” Section Daily Schedule</h2>
      <div id="auth-area">
        <div id="g_id_onload"
             data-client_id="GOOGLE_CLIENT_ID_REPLACE"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false"></div>
        <div id="buttonDiv"></div>
        <div id="user-info" style="display:none"></div>
      </div>
    </header>
    
    <section class="card">
      <h3>Today's classes</h3>
      <div id="schedule">Loading...</div>
    </section>
    
    <section class="card">
      <h3>My Attendance</h3>
      <div id="my-att">Sign in to view your attendance.</div>
    </section>
    
    <section class="card">
      <h3>Reports & Downloads (Officers / Professors)</h3>
      <div id="report-controls" style="display:none">
        <label>Class ID: <input id="r_class" /></label>
        <label>Date (yyyy-mm-dd): <input id="r_date" /></label>
        <label>Student email: <input id="r_person" /></label>
        <button id="gen-report">Generate CSV</button>
        <a id="download-link" style="display:none">Download</a>
        <div id="report-result"></div>
      </div>
      <div id="roles-list" class="small"></div>
    </section>
  
    <script>
      // Replace this with web app URL only if hosting front-end separately on GH Pages
      const APPS_SCRIPT_BASE = ''; // if blank, we call server via google.script.run (Apps Script hosting)
      const GOOGLE_CLIENT_ID = 'GOOGLE_CLIENT_ID_REPLACE';
    
      let currentIdToken = null;
      let currentEmail = null;
      let currentRole = null;
    
      // Google Identity Services callback
      function handleCredentialResponse(response) {
        if (!response || !response.credential) return;
        currentIdToken = response.credential;
        // verify & load user data from server
        if (APPS_SCRIPT_BASE) {
          // external hosting: call tokeninfo endpoint yourself then call server endpoints
          alert('If hosting externally, set APPS_SCRIPT_BASE to your Apps Script API URL and implement fetch calls instead of google.script.run.');
        } else {
          google.script.run.withSuccessHandler(onVerified).verifyIdToken(currentIdToken);
        }
      }
    
      function onVerified(email) {
        currentEmail = email;
        document.getElementById('user-info').style.display = 'block';
        document.getElementById('user-info').innerText = 'Signed in: ' + email + '  ';
        // store a token-like placeholder for server calls (we already have id_token)
        loadTodaySchedule();
        loadMyAttendance();
        loadRolesList();
        // show report controls if role allows (server will still enforce)
        google.script.run.withSuccessHandler(showRoleControls).getRole ? google.script.run.withSuccessHandler(showRoleControls).getRole(currentIdToken) : null;
      }
    
      function showRoleControls(role) {
        currentRole = role;
        if (role === 'officer' || role === 'professor') {
          document.getElementById('report-controls').style.display = 'block';
        }
      }
    
      // Render schedule for today
      function loadTodaySchedule() {
        document.getElementById('schedule').innerText = 'Loading...';
        google.script.run.withSuccessHandler(renderSchedule).getTodaySchedule(currentIdToken || currentEmail);
      }
    
      function renderSchedule(list) {
        if (!list || list.length === 0) {
          document.getElementById('schedule').innerText = 'No classes today for your section.';
          return;
        }
        const container = document.createElement('div');
        const now = new Date();
        list.forEach(item => {
          const card = document.createElement('div');
          card.className = 'card';
          const h = document.createElement('div');
          h.innerHTML = `<strong>${item.class_name}</strong> <span class="small">(${item.class_id})</span>`;
          const times = document.createElement('div');
          times.className = 'small';
          times.innerText = `${item.start_time} - ${item.end_time} | Prof: ${item.professor_email}`;
          const btn = document.createElement('button');
          btn.innerText = 'Check-in';
          btn.id = 'btn-' + item.class_id;
          btn.onclick = () => doCheckin(item.class_id, btn);
          // compute enable/disable times client-side for UX:
          const startParts = item.start_time.split(':');
          const startDt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(startParts[0]), parseInt(startParts[1]));
          const openWin = new Date(startDt.getTime() - 10*60*1000);
          const absentThreshold = new Date(startDt.getTime() + 10*60*1000);
          if (now < openWin) {
            btn.disabled = true;
            btn.innerText = 'Opens at ' + openWin.toLocaleTimeString();
          } else if (now >= absentThreshold) {
            btn.disabled = true;
            btn.innerText = 'Absent (disabled)';
          } else {
            btn.disabled = false;
          }
          card.appendChild(h);
          card.appendChild(times);
          card.appendChild(btn);
          container.appendChild(card);
        });
        const sc = document.getElementById('schedule');
        sc.innerHTML = '';
        sc.appendChild(container);
      }
    
      function doCheckin(class_id, btn) {
        btn.disabled = true;
        btn.innerText = 'Checking...';
        google.script.run.withSuccessHandler(res => {
          btn.innerText = 'Checked: ' + res.status;
          loadMyAttendance();
        }).withFailureHandler(err => {
          btn.disabled = false;
          alert('Check-in failed: ' + err.message);
          loadTodaySchedule();
        }).checkIn(currentIdToken, class_id);
      }
    
      function loadMyAttendance() {
        google.script.run.withSuccessHandler(renderMyAttendance).getMyAttendance(currentIdToken);
      }
    
      function renderMyAttendance(list) {
        const el = document.getElementById('my-att');
        if (!list || list.length === 0) {
          el.innerText = 'No attendance records yet.';
          return;
        }
        const tbl = document.createElement('table');
        const h = document.createElement('tr');
        h.innerHTML = '<th>Date</th><th>Class</th><th>Status</th><th>Check-in</th>';
        tbl.appendChild(h);
        list.forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${r.date}</td><td>${r.class_id}</td><td>${r.status}</td><td>${r.checkin_time}</td>`;
          tbl.appendChild(tr);
        });
        el.innerHTML = '';
        el.appendChild(tbl);
      }
    
      function loadRolesList() {
        google.script.run.withSuccessHandler(list => {
          const el = document.getElementById('roles-list');
          const profs = list.filter(x => x.role && x.role.toLowerCase()==='professor').map(x => x.email);
          const offs = list.filter(x => x.role && x.role.toLowerCase()==='officer').map(x => x.email);
          el.innerHTML = '<strong>Professors:</strong> ' + profs.join(', ') + '<br/><strong>Officers:</strong> ' + offs.join(', ');
        }).getRolesList(currentIdToken);
      }
    
      document.getElementById('gen-report').onclick = function(){
        const params = {
          class_id: document.getElementById('r_class').value,
          date: document.getElementById('r_date').value,
          person_email: document.getElementById('r_person').value
        };
        google.script.run.withSuccessHandler(csv => {
          if (!csv) {
            document.getElementById('report-result').innerText = 'No data for the selected filters.';
            return;
          }
          const blob = new Blob([csv], {type:'text/csv'});
          const url = URL.createObjectURL(blob);
          const link = document.getElementById('download-link');
          link.href = url;
          link.download = 'attendance_report.csv';
          link.style.display = 'inline';
          link.innerText = 'Download CSV';
          document.getElementById('report-result').innerText = 'Report ready.';
        }).withFailureHandler(err => alert('Error: ' + err.message)).generateAttendanceReport(currentIdToken, params);
      };
    
      // render Google sign-in button after library loads
      window.onload = function(){
        google.accounts.id.initialize({
          client_id: GOOGLE_CLIENT_ID,
          callback: handleCredentialResponse
        });
        google.accounts.id.renderButton(
          document.getElementById('buttonDiv'),
          { theme: 'outline', size: 'medium' }  // customization
        );
        google.accounts.id.prompt(); // optionally show one-tap
      };
    </script>
  </body>
</html>
